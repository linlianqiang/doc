## 前言

代码质量有以下及部分组成：

* 实现业务功能：实现功能、健壮的代码
* 代码的可读性
* 代码的复杂度：可复用、可重构

代码的价值在于**实现业务功能**。不能实现业务功能的代码，写的再好也没有价值。因此，代码首先要实现业务功能。

读代码是个高频操作。每次改代码前，都会读代码。同时，提升代码的可读性，成本不是很高。从投入产出的角度来看，提升代码可读性的性价比高。

最后，就是降低代码的复杂度。要降低代码的**复杂度**，需要花大量时间去做调研和设计，往往还会走一些弯路。降低复杂系统的复杂度，对团队和个人来说，都是一个挑战。因此，把这块放到最后。



<img src="/../media/image-20220418104530994.png" style="zoom: 50%;" />



## 代码健壮性

健壮性是指程序在遇到规范以外的输入，错误和异常时，仍能正常运行。不轻易崩溃。

不健壮的前端代码体现为：

* 接口返回异常或报错，页面白屏。

* 用户做一些非常规操作时，页面白屏

#### 异常处理

如果不做异常处理，轻则导致功能出错，重则导致白屏。分为：

###### 主动捕获运行时异常

用 try-catch 捕获同步代码错误，异步代码 用await 写法。

```js
try {
    doSth()
    await doSth()
} catch(e) {
    // 处理异常
}
```



###### 处理意料之外的全局运行时异常

未被处理的js运行时错误（包括语法错误）发生时，window会触发error事件。

```js
window.addEventListener('error',(e) => {
        // 处理异常
})
```

当一项资源（img / script）加载失败时，加载资源的元素会触发error事件。这么处理：

```js
const img = new Image();
img.addEventListener('error', (e) => {
	//  处理异常
})
img.src = 'xxx';
```

#### 接口请求的成功或失败

```js
getMissionsList({ mission_type: 'spider_sstw' })
    .then((res) => {
      listData.value = res
      tableRefreshAt.value = dayjs().format('YYYY-MM-DD HH:mm:ss')
    })
    .catch(() => {})
    .finally(() => {
      searchLoading.value = false
    })
```

#### 输入检查 

入参及类型推断 - 通过ts处理

#### 第三方库的选择

* 使用方式更直观，易读
* 体积更小
* 是否有在维护

## 代码可读性

#### 风格

规范交给工具：eslint、prettier husky

#### 命名

* 直白的，有意义的
* 文件：要有业务含义，遵循行业惯例的，不要既有业务含义，又有表现形式的含义。eg:  fileUploadDialog ?? ，fileUpload（正确），gameList ?
* 符合代码风格
* 不要太长的名字
* 必要的注释

#### 代码

* 没有大文件
* 没有嵌套很深的代码
* 没有回调地狱
* if嵌套层级

#### 注释

* html表明每个模块

## 代码复用性

* 共同业务组件及时抽取，如项目都用到的全局弹窗：提示窗，业务功能窗
* 表格的操作可以加变量扩展，避免太多方法
* 复杂的写法要考虑优化



## 代码可重构

可重构的代码是易于维护的。对于非可重构的代码，如果改了某模块，可能会导致一系列相关改动。如何找到改动会导致的影响？这不仅需要工作量，还有漏改导致的质量风险。

## 如何写出可重构的代码

写出可重构的代码要做 3 件事：

1. 隔离副作用。
2. 使用静态类型。
3. 写测试。

隔离副作用是写出可重构代码的基础。使用静态类型是对过程的检查。写测试是对结果的检查。

下面具体来说。

#### 1 隔离副作用

副作用指修改模块外的数据。常见的模块外的数据有：全局变量，Web Storage，DOM，组件间共享的数据，其他模块的内部数据。

在模块代码中，混入副作用代码会导致如下的问题：

1. 副作用让代码变得难以测试。当模块依赖的外部数据发生变化后，模块的返回值可能会变化。这让模块的返回变得不稳定。
2. 副作用会导致模块间的耦合。如果多个模块都依赖某个外部数据，那这几个外部模块之间是耦合的。多个模块改都可以改外部数据，数据流很混乱。
3. 副作用让我们的系统变得不可预测。如果一个模块改了外部数据，可能会影响整个系统。

如何隔离副作用？方法是：

1. 建一个数据中心来管理共享数据的获取和修改。模块获取和修改共享数据，需要用数据中心提供的 API。这样做降低了模块之间的耦合：当共享数据变化后，只需修改数据中心的逻辑。
2. 模块需要修改其他模块的内部数据，要通过其他模块暴露的方法，而不是直接改值。

#### 2 使用静态类型

使用静态类型可以规避很多低级的语法和逻辑错误，比如参数少传了，参数的类型传错了等。

```js
function add(a: number, b: number) : number {
 return a + b
}
// 编译报错: 参数少传了。
add(3)
// 编译报错：参数的类型传错了。
add(3, '4')
```

复制

修改某个 API 后，通过静态类型检查，我们可以知道，哪些调用的地方需要做对应的修改。

JavaScript 是个弱类型语言，不支持静态类型检查。可以用 [TypeScript](https://www.typescriptlang.org/) 来做静态类型检查。
